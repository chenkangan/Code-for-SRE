library(pracma)
dspl1=function(n,t,k,  x0=c(1.886911e-11 ,3.762363e-08 ,5.927867e-04 ,1.183419e-02 ,7.380856e-03 ,1.682365e-07,4.764025e-03)
){
  ndat=length(n)
  knots=round((0:(k+1))*ndat/(k+1))
  knots[1]=1
  m=k+2
  kn=1:m
  for(i in 1:m){kn[i]= t[knots[i]]}
  dn=gen(n)
  M=matrix(1:(length(t)*(k+3)),ncol = length(t),nrow = k+3)
  for (j in 1:(k+3)){
    for(i in 1:length(t)){
      M[j,i]=base_int(t[i],j,t,k,length(t),knots,kn)
    }
  }
  M0=matrix(1:(length(t)*(k+3)),ncol = length(t),nrow = k+3)
  for (j in 1:(k+3)){
    for(i in 1:length(t)){
      M0[j,i]=base_fun(t[i],j,t,k,length(t),knots,kn)
    }
  }
  A=diag(m+1)
  sigma=t(apply(M, 1, diff))
  objfun <- function(x) {
    -(sum(dn*(log(t(x)%*%sigma)))-c(t(x)%*%M[,ncol(M)]))
  }
  grad_fun <- function(x) {
    -(sigma %*% t(dn*(1/(t(x) %*% sigma))) - M[,ncol(M)])
  }
  grad_fun <- function(x) {
    grad <- grad(f = objfun, x = x)
    return(grad)
  }
  # x0=c(1.886911e-11 ,3.762363e-08 ,5.927867e-04 ,1.183419e-02 ,7.380856e-03 ,1.682365e-07,4.764025e-03)
  ci <- rep(0, m+1)
  x0=rep(0.1,m+1)
  # 运行优化z
  result <- constrOptim(x0, objfun, ui=A, ci=ci, grad=grad_fun)
  beta=result$par
  ans=new.env()
  ans$M0=M0
  ans$M=M
  ans$beta=beta
  ans$xpl=t
  return(ans)
}




# xdat = c(0, 32.4375, 64.875, 97.3125, 129.75, 162.1875, 194.625, 227.0625, 259.5, 291.9375, 324.375, 356.8125, 389.25, 421.6875, 454.125, 486.5625, 519.0, 575.125, 631.25, 687.375, 743.5, 799.625, 855.75, 911.875, 968.0, 1122.0, 1276.0, 1430.0, 1507.1666666666667, 1584.3333333333333, 1661.5, 1738.6666666666667, 1815.8333333333335, 1893.0, 1967.625, 2042.25, 2116.875, 2191.5, 2266.125, 2340.75, 2415.375, 2490.0, 2561.0, 2632.0, 2703.0, 2774.0, 2845.0, 2916.0, 2987.0, 3058.0, 3171.4, 3284.8, 3398.2, 3511.6, 3625.0, 3824.25, 4023.5, 4222.75, 4422.0, 4494.363636363636, 4566.727272727273, 4639.090909090909, 4711.454545454545, 4783.818181818182, 4856.181818181818, 4928.545454545454, 5000.909090909091, 5073.272727272727, 5145.636363636364, 5218.0, 5318.833333333333, 5419.666666666667, 5520.5, 5621.333333333333, 5722.166666666667, 5823.0, 5942.333333333333, 6061.666666666667, 6181.0, 6300.333333333333, 6419.666666666667, 6539.0, 6647.8, 6756.6, 6865.4, 6974.2, 7083.0, 7184.0, 7285.0, 7386.0, 7487.0, 7606.666666666667, 7726.333333333333, 7846.0, 7965.666666666667, 8085.333333333333, 8205.0, 8384.5, 8564.0, 8923.0, 9282.0)
# n1 = c(0,16,24,27,33,41,49,54,58,69,75,81,86,90,93,96,98,99,100,100,100)
# t1 = c(0,519,968,1430,1893,2490,3058,3625,4422,5218,5823,6539,7083,7487,7846,8205,8564,8923,9282,9641,10000)
# n2 = c(0,13,18,26,34,40,48,61,75, 84, 89, 95, 100, 104, 110 ,112, 114, 117, 118, 120)
# t2 = c(0,384,1186,1471,2236,2772,2967,3812,4880,6104,6634,7229,8072,8484,8847,9253,9712,10083,10174,10272)
# n3 = c(0,6, 9, 13, 20, 28, 40, 48, 54, 57, 59, 60, 61)
# t3 = c(0,162, 499, 715, 1137, 1799 ,2438 ,2818, 3574 ,4234, 4680 ,4955, 5053)
# n4 = c(0,1,3,8,9,11,16,19,25,27,29,32,32,36,38,39,39,41,42,42)
# t4 = c(0,254,788,1054,1393,2216,2880,3593,4281,5180,6003,7621,8783,9604,10064,10560,11008,11237,11243,11305)


discon = function(n,t,k){
  ans=dspl1(n,t,k)
  M=ans$M
  M0=ans$M0
  
  
  y=ans$beta%*%ans$M
  c=max(n)/max(y)
  
  
  
  # MLE=sum(log(ans$beta%*%ans$M0)*c)-c*y[length(y)]
  MLE=sum(gen(n)*log(ans$beta%*%t(apply(ans$M, 1, diff))*c))-c*y[length(y)]
  
  MSE=sqrt(sum((c*y-n)^2))/(length(n)-1)
  
  # MSE0=
  re=new.env()
  re$MSE=MSE
  re$MLE=MLE
  re$l=ans$xpl
  re$su=y*c
  return(re)
}


# datac=readRDS('discon.rds')

# xdat1=datac[[1]][[1]][[1]]
# n=datac[[1]][[1]][[2]]
# res=discon(n1,t1,4)



# lines(ans$xpl,2*dnorm(ans$xpl))
# points(xdat,1:length(xdat)*0,pch="|")
# points(ans$knots,1:6*0,pch="X",col=2)
